# BHXH API - Code Standards

## 1. File Naming Convention

| Pattern | Examples | Purpose |
|---------|----------|---------|
| `kebab-case` | `local-server.ts`, `api-key.middleware.ts` | TypeScript source files |
| `kebab-case` | `project-overview-pdr.md` | Documentation files |
| `kebab-case` | `employee-list-api-docs.md` | Detailed API docs |

**Rule**: Use long, descriptive names so LLMs can understand purpose without reading content.

## 2. Code Structure Guidelines

### 2.1 Maximum File Size

- **TypeScript files**: Under 200 lines when possible
- **Controllers**: Under 150 lines (split complex endpoints)
- **Services**: Under 300 lines (extract helpers)
- **Models**: Keep focused, one per file

### 2.2 Module Boundaries

```
src/
├── local-server.ts           # Entry point
├── middleware/               # Express middleware
│   └── api-key.middleware.ts
├── controllers/              # tsoa REST controllers
│   ├── health.controller.ts
│   ├── employees.controller.ts
│   ├── session.controller.ts
│   └── master-data.controller.ts
├── services/                 # Business logic
│   ├── session.service.ts
│   ├── bhxh.service.ts
│   └── proxy.service.ts
├── models/                   # TypeScript interfaces
│   ├── session.model.ts
│   ├── employee.model.ts
│   └── master-data.model.ts
├── crypto.ts                 # Encryption utilities
└── generated/                # Auto-generated by tsoa
    ├── routes.ts
    └── swagger.json
```

### 2.3 Composition Over Inheritance

```typescript
// Good: Functional composition
export function createApiKeyMiddleware(config?: ApiKeyConfig) {
  return (req: Request, res: Response, next: NextFunction) => {
    // Middleware logic
  };
}

// Good: Service composition
const session = await getValidSession(username, password);
const employees = await fetchEmployees(session, params);

// Avoid: Deep inheritance hierarchies
class BaseApiController extends AbstractController implements IController {}
```

## 3. TypeScript Standards

### 3.1 Type Definitions

```typescript
// Interfaces for data transfer objects
interface Employee {
  id: number;
  Hoten: string;
  Masobhxh: string;
  chucVu?: string;
  mucLuong?: number;
}

// Service layer interfaces
interface Session {
  token: string;
  xClient: string;
  currentDonVi: DonVi;
  expiresAt: number;
}

// Controller response types
interface EmployeeListResponse {
  success: boolean;
  data: Employee[];
  meta?: {
    total?: number;
    count?: number;
  };
  timing?: {
    sessionMs: number;
    fetchMs: number;
    totalMs: number;
  };
}
```

### 3.2 Strict Mode Configuration

```json
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "esModuleInterop": true,
    "experimentalDecorators": true,
    "emitDecoratorMetadata": true
  }
}
```

### 3.3 Export Patterns

```typescript
// Named exports for functions
export function getValidSession(username?: string, password?: string): Promise<Session> {}
export function refreshSession(username?: string, password?: string): Promise<Session> {}

// Default export for middleware
export default { createApiKeyMiddleware, getValidApiKeys, isValidApiKey };

// tsoa controllers use class exports
@Route("/api/v1/employees")
export class EmployeesController extends Controller {}
```

## 4. Error Handling

### 4.1 Try-Catch Pattern

```typescript
try {
  const session = await getValidSession(username, password);
  const data = await lookup(session, "071");
  return { success: true, data };
} catch (error) {
  const message = error instanceof Error ? error.message : "Unknown error";
  console.error("Paper types fetch error:", message);
  throw {
    error: "Failed to fetch paper types",
    message,
  };
}
```

### 4.2 Error Response Format

```typescript
// Consistent error format
interface ErrorResponse {
  error: string;
  message: string;
}

// Thrown from controllers
throw {
  error: "Failed to fetch employees",
  message: "BHXH credentials not provided",
};
```

### 4.3 Status Codes

| Code | Usage |
|------|-------|
| 200 | Success |
| 401 | Missing X-API-Key header |
| 403 | Invalid X-API-Key |
| 500 | Internal server error |

## 5. Session Management

### 5.1 In-Memory Caching Pattern

```typescript
const TOKEN_TTL_SECONDS = 3600;
const sessionCache = new Map<string, Session>();

async function getValidSession(
  username?: string,
  password?: string
): Promise<Session> {
  const cacheKey = createCacheKey(username, password);
  const cached = sessionCache.get(cacheKey);

  if (cached && cached.expiresAt > Date.now()) {
    console.log(`Using cached session for ${cacheKey.substring(0, 10)}...`);
    return cached;
  }

  return performLogin(username, password);
}
```

### 5.2 Cache Key Strategy

```typescript
function createCacheKey(username?: string, password?: string): string {
  if (username && password) {
    // Unique key per credentials for multi-tenant support
    return `${username}:${password.substring(0, 3)}***`;
  }
  // Default key for fallback credentials
  return "default";
}
```

### 5.3 Session Validation

```typescript
async function getSessionStatus(
  username?: string,
  password?: string
): Promise<{
  status: "active" | "expired";
  expiresIn: number;
  unit?: string;
}> {
  const cacheKey = createCacheKey(username, password);
  const cached = sessionCache.get(cacheKey);

  if (cached && cached.expiresAt > Date.now()) {
    const expiresIn = Math.floor((cached.expiresAt - Date.now()) / 1000);
    return {
      status: "active",
      expiresIn,
      unit: cached.currentDonVi.Ten || "Unknown",
    };
  }

  return { status: "expired", expiresIn: 0 };
}
```

## 6. HTTP Client Patterns

### 6.1 Axios with Proxy Support

```typescript
import axios, { AxiosInstance } from "axios";
import { HttpsProxyAgent } from "https-proxy-agent";

export function createAxios(): AxiosInstance {
  return axios.create({
    httpsAgent: getHttpsAgent(),
  });
}

// Use in services
const axiosInstance = createAxios();
const response = await axiosInstance.post(url, data, {
  headers: { "User-Agent": "Mozilla/5.0..." },
});
```

### 6.2 Request Headers

```typescript
const headers = {
  "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
  "Accept": "application/json, text/plain, */*",
  "Content-Type": "application/json",
  "Authorization": `Bearer ${session.token}`,
  "X-CLIENT": session.xClient,
};
```

## 7. tsoa Controller Standards

### 7.1 Controller Structure

```typescript
import { Controller, Route, Get, Query, SuccessResponse, Response } from "tsoa";

@Route("/api/v1/employees")
export class EmployeesController extends Controller {
  /**
   * Get all employees for current unit
   * @param username - BHXH username for per-request authentication
   * @param password - BHXH password for per-request authentication
   * @param PageIndex - Page number (default 1)
   * @param PageSize - Page size (default 100)
   * @returns Employee list with pagination info
   */
  @Get("/")
  @SuccessResponse(200, "OK")
  @Response<{ error: string; message: string }>(500, "Failed to fetch employees")
  public async getEmployees(
    @Query() username?: string,
    @Query() password?: string,
    @Query() PageIndex?: number,
    @Query() PageSize?: number
  ): Promise<EmployeeListResponse> {
    // Implementation
  }
}
```

### 7.2 Decorator Usage

```typescript
// Route decorator (class level)
@Route("/api/v1/master-data")

// HTTP method decorators
@Get("/paper-types")
@Post("/session/refresh")

// Response decorators
@SuccessResponse(200, "OK")
@Response<ErrorResponse>(401, "Unauthorized")
@Response<ErrorResponse>(500, "Internal Error")

// Parameter decorators
@Query() username?: string
@Query() PageIndex?: number
```

### 7.3 Per-Request Credentials

```typescript
// All controllers should accept optional username/password
public async getEmployees(
  @Query() username?: string,
  @Query() password?: string,
  // ... other params
): Promise<EmployeeListResponse> {
  // Pass to service layer
  const session = await getValidSession(username, password);
  // ...
}
```

## 8. Middleware Standards

### 8.1 Middleware Structure

```typescript
import { Request, Response, NextFunction } from "express";

export function createApiKeyMiddleware(config?: ApiKeyConfig) {
  return (req: Request, res: Response, next: NextFunction) => {
    // Check public paths
    const isPublic = config.publicPaths.some((path) =>
      req.path.startsWith(path)
    );
    if (isPublic) return next();

    // Validate API key
    const apiKey = req.headers["x-api-key"] as string | undefined;
    if (!apiKey) {
      return res.status(401).json({
        error: "Unauthorized",
        message: "Missing X-API-Key header",
      });
    }

    if (!config.keys.includes(apiKey)) {
      return res.status(403).json({
        error: "Forbidden",
        message: "Invalid API key",
      });
    }

    next();
  };
}
```

### 8.2 Middleware Order

```typescript
// In local-server.ts
app.use(express.json());                    // 1. Body parser
app.use(createApiKeyMiddleware());          // 2. API key auth
app.use("/docs", swaggerUi.serve);         // 3. Swagger UI
RegisterRoutes(app);                        // 4. tsoa routes
app.use(errorHandler);                      // 5. Error handler
```

## 9. Logging Standards

### 9.1 Log Levels

```typescript
console.log("Using cached session...");           // Info
console.log("[PROFILE] GET /employees - 250ms");  // Timing
console.warn("Cache miss, performing login");     // Warning
console.error("Employees fetch error:", error);   // Error
```

### 9.2 Sensitive Data Handling

**NEVER log:**
- Full passwords
- Full API keys (truncate after 10 chars)
- Session tokens
- BHXH credentials in full

**DO log:**
- Truncated API keys: `sk_test_abc1...`
- Truncated cache keys: `user@example.com:pas***`
- Username only (not password)

## 10. Documentation Comments

### 10.1 Function Documentation

```typescript
/**
 * Get or refresh session token
 * @param username - Optional BHXH username for per-request auth
 * @param password - Optional BHXH password for per-request auth
 * @returns Valid Session object
 */
export async function getValidSession(
  username?: string,
  password?: string
): Promise<Session> {
  // Implementation
}
```

### 10.2 Interface Documentation

```typescript
/**
 * BHXH Session data cached in-memory
 */
interface Session {
  /** OAuth access token from BHXH */
  token: string;
  /** Encrypted client ID header */
  xClient: string;
  /** Current working unit */
  currentDonVi: DonVi;
  /** Unix timestamp in milliseconds */
  expiresAt: number;
}
```

## 11. Environment Configuration

### 11.1 Required Variables

```bash
# .dev.vars - Never commit this file
API_KEYS=sk_test_abc123def456,sk_prod_xyz789ghi012
```

### 11.2 Optional Variables

```bash
# Fallback BHXH credentials (used if username/password not in request)
BHXH_USERNAME=your@email.com
BHXH_PASSWORD=yourpassword

# Optional configuration
BHXH_ENCRYPTION_KEY=S6|d'qc1GG,'rx&xn0XC
AI_CAPTCHA_ENDPOINT=http://api.example.com/captcha/solve
USE_PROXY=true
EXTERNAL_PROXY_URL=http://proxy.example.com:3128
EXTERNAL_PROXY_USERNAME=proxyuser
EXTERNAL_PROXY_PASSWORD=proxypass
```

### 11.3 Loading Environment

```typescript
// In local-server.ts and services
import dotenv from "dotenv";
dotenv.config({ path: ".dev.vars" });

// Access variables
const apiKey = process.env.API_KEYS;
const username = process.env.BHXH_USERNAME;
```

## 12. Testing Guidelines

### 12.1 Test Coverage Priority

1. API key middleware authentication
2. Session caching behavior
3. Per-request credentials isolation
4. Error handling
5. Proxy configuration

### 12.2 Test Structure

```typescript
import { describe, it, expect } from "vitest";

describe("api-key.middleware", () => {
  it("should allow requests with valid API key", async () => {
    const middleware = createApiKeyMiddleware({
      keys: ["test-key"],
      publicPaths: ["/"],
    });
    // Test implementation
  });

  it("should reject requests with missing API key", async () => {
    // Test implementation
  });

  it("should reject requests with invalid API key", async () => {
    // Test implementation
  });
});
```

## 13. Security Standards

### 13.1 Input Validation

```typescript
// tsoa validates types automatically
// Additional validation in controllers:
if (!username || !password) {
  throw new Error("BHXH credentials not provided");
}
```

### 13.2 API Key Management

```typescript
// Parse from environment
function parseApiKeys(keysStr: string): string[] {
  if (!keysStr.trim()) return [];
  return keysStr.split(",").map((k) => k.trim()).filter(Boolean);
}

// Validate
function isValidApiKey(apiKey: string): boolean {
  return getValidApiKeys().includes(apiKey);
}
```

### 13.3 CORS Configuration

```typescript
// For production, configure specific origins
const corsOptions = {
  origin: process.env.ALLOWED_ORIGINS?.split(",") || "*",
  methods: ["GET", "POST"],
  allowedHeaders: ["Content-Type", "X-API-Key"],
};
```

## 14. Git Commit Standards

```bash
# Good commit messages
feat: add api-key middleware for authentication
feat: add per-request BHXH credentials support
fix: resolve session cache key collision
docs: update API reference with new endpoints
refactor: extract proxy service from bhxh service
chore: update tsoa to v6.6.0

# Avoid
Update file
Fix stuff
WIP
```

## 15. Related Documentation

- [Project Overview & PDR](./project-overview-pdr.md)
- [System Architecture](./system-architecture.md)
- [Codebase Summary](./codebase-summary.md)
- [Deployment Guide](./deployment-guide.md)
